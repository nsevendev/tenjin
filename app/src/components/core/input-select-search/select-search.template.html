<div class="relative w-full">
  <!-- Trigger -->
  <div
    [class]="triggerClasses()"
    [attr.aria-invalid]="variant() === 'error' || null"
    [class.opacity-50]="disabled()"
    [class.cursor-not-allowed]="disabled()"
    role="combobox"
    aria-haspopup="listbox"
    [attr.aria-expanded]="open()"
    tabindex="0"
    #triggerEl
    (click)="toggleOpen()"
    (keydown)="onKeydown($event)"
  >
    <div class="truncate">
      @if (!selectedLabel()) {
        <span class="text-gray-400">{{ placeholder() }}</span>
      } @else {
        <span>{{ selectedLabel() }}</span>
      }
    </div>
    @if (value() !== null) {
      <button type="button" class="absolute right-8 inset-y-0 flex items-center text-gray-500 hover:text-gray-700 p-2 -m-2" (click)="clear($event)">
        <c-h-icon [name]="'x'" class="h-4 w-4"></c-h-icon>
      </button>
    }
  </div>

  <!-- Chevron -->
  <span class="pointer-events-none absolute inset-y-0 right-0 flex items-center pr-3 text-gray-500">
    <svg class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
      <path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 11.168l3.71-3.938a.75.75 0 111.08 1.04l-4.24 4.5a.75.75 0 01-1.08 0l-4.24-4.5a.75.75 0 01.02-1.06z" clip-rule="evenodd" />
    </svg>
  </span>

  <!-- Panel -->
  @if (open() && !useSheet()) {
    <div class="absolute z-10 mt-1 w-full bg-white border border-gray-300 rounded-md shadow-lg max-h-[70vh] md:max-h-72 overflow-auto" role="listbox">
      <div class="p-2 border-b border-gray-200 sticky top-0 bg-white">
        <input
          type="text"
          class="w-full px-3 py-2 text-sm border border-gray-300 rounded-md outline-none focus:border-primary"
          [placeholder]="'Rechercher...'"
          [ngModel]="query()"
          (ngModelChange)="query.set($event)"
          (click)="$event.stopPropagation()"
          #searchInputRef
          (keydown)="onPanelKeydown($event)"
        />
      </div>
      <div class="p-1">
        @if (!filtered().length) {
          <div class="text-sm text-gray-500 px-2 py-2">Aucun résultat</div>
        } @else {
          @for (opt of filtered(); track opt.value; let i = $index) {
            <button #optEl type="button" class="w-full text-left px-3 py-3 md:py-2 rounded-md hover:bg-gray-100" [class.bg-gray-100]="activeIndex() === i" role="option" [attr.aria-selected]="value() === opt.value" (click)="setValue(opt.value)">
              {{ opt.label }}
            </button>
          }
        }
      </div>
    </div>
  }

  @if (open() && useSheet()) {
    <c-bottom-sheet [(open)]="open">
      <div cSheetContent>
        <div class="p-2 border-b border-gray-200 sticky top-0 bg-white">
          <input
            type="text"
            class="w-full px-3 py-3 text-base border border-gray-300 rounded-md outline-none focus:border-primary"
            [placeholder]="'Rechercher...'"
            [ngModel]="query()"
            (ngModelChange)="query.set($event)"
            #searchInputRef
            (keydown)="onPanelKeydown($event)"
          />
        </div>
        <div class="p-1">
          @if (!filtered().length) {
            <div class="text-sm text-gray-500 px-2 py-2">Aucun résultat</div>
          } @else {
            @for (opt of filtered(); track opt.value; let i = $index) {
              <button #optEl type="button" class="w-full text-left px-4 py-4 rounded-md hover:bg-gray-100" [class.bg-gray-100]="activeIndex() === i" role="option" [attr.aria-selected]="value() === opt.value" (click)="setValue(opt.value)">
                {{ opt.label }}
              </button>
            }
          }
        </div>
      </div>
    </c-bottom-sheet>
  }
</div>
